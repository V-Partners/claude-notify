<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Claude Notify</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#030508">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #030508;
            --surface: #0d1117;
            --border: #21262d;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --accent: #00e5ff;
            --success: #3fb950;
            --warning: #d29922;
            --error: #f85149;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo h1 {
            font-size: 18px;
            font-weight: 600;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }
        .status-dot.disconnected { background: var(--error); }
        .status-dot.pending { background: var(--warning); }
        main {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .notification {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .notification-title {
            font-weight: 600;
            font-size: 15px;
        }
        .notification-time {
            font-size: 12px;
            color: var(--text-dim);
        }
        .notification-body {
            color: var(--text-dim);
            font-size: 14px;
            line-height: 1.5;
        }
        .notification-type {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 8px;
            background: rgba(0, 229, 255, 0.15);
            color: var(--accent);
        }
        .notification-type.waiting {
            background: rgba(210, 153, 34, 0.15);
            color: var(--warning);
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-dim);
        }
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        footer {
            padding: 16px 20px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        button {
            flex: 1;
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary {
            background: var(--border);
            color: var(--text);
        }
        button.enabled {
            background: var(--success);
        }
        .hidden { display: none !important; }
        .refresh-hint {
            text-align: center;
            padding: 12px;
            color: var(--text-dim);
            font-size: 13px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>Claude Notify</h1>
        </div>
        <div class="status-dot" id="status-dot" title="Connected"></div>
    </header>

    <main>
        <div class="notification-list" id="notifications"></div>
        <div class="empty-state hidden" id="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <p>No notifications yet</p>
            <p style="font-size: 13px; margin-top: 8px;">Claude will notify you when tasks complete</p>
        </div>
    </main>

    <footer>
        <button id="toggle-btn" onclick="toggleNotifications()">Enable</button>
        <button class="secondary" onclick="sendTest()">Test</button>
    </footer>

    <script>
        let notificationsEnabled = false;
        let swRegistration = null;

        async function init() {
            await checkStatus();
            await loadNotifications();
            setInterval(loadNotifications, 30000);
        }

        async function checkStatus() {
            const dot = document.getElementById('status-dot');
            const btn = document.getElementById('toggle-btn');

            try {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    dot.classList.add('disconnected');
                    btn.textContent = 'Not Supported';
                    btn.disabled = true;
                    return;
                }

                swRegistration = await navigator.serviceWorker.register('/sw.js');

                const subscription = await swRegistration.pushManager.getSubscription();
                notificationsEnabled = !!subscription;

                if (notificationsEnabled) {
                    btn.textContent = 'Disable';
                    btn.classList.add('enabled');
                    dot.classList.remove('disconnected', 'pending');
                } else {
                    btn.textContent = 'Enable';
                    btn.classList.remove('enabled');
                    dot.classList.add('pending');
                }

            } catch (e) {
                console.error('Status check failed:', e);
                dot.classList.add('disconnected');
            }
        }

        async function loadNotifications() {
            try {
                const res = await fetch('/api/claude/history?limit=50');
                const notifications = await res.json();

                const list = document.getElementById('notifications');
                const empty = document.getElementById('empty-state');

                if (notifications.length === 0) {
                    list.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                list.classList.remove('hidden');

                list.innerHTML = notifications.map(n => `
                    <div class="notification">
                        <div class="notification-header">
                            <span class="notification-title">${escapeHtml(n.title)}</span>
                            <span class="notification-time">${formatTime(n.timestamp)}</span>
                        </div>
                        ${n.body ? `<div class="notification-body">${escapeHtml(n.body)}</div>` : ''}
                        <span class="notification-type ${n.notification_type}">${n.notification_type}</span>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Failed to load notifications:', e);
            }
        }

        async function toggleNotifications() {
            const btn = document.getElementById('toggle-btn');
            btn.disabled = true;

            try {
                if (notificationsEnabled) {
                    const subscription = await swRegistration.pushManager.getSubscription();
                    if (subscription) {
                        await fetch('/api/push/unsubscribe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ endpoint: subscription.endpoint })
                        });
                        await subscription.unsubscribe();
                    }
                } else {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        btn.textContent = 'Denied';
                        btn.disabled = false;
                        return;
                    }

                    const res = await fetch('/api/vapid-public-key');
                    const { publicKey } = await res.json();

                    const subscription = await swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });

                    await fetch('/api/push/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(subscription.toJSON())
                    });
                }

                await checkStatus();
            } catch (e) {
                console.error('Toggle failed:', e);
                btn.textContent = 'Error';
            }

            btn.disabled = false;
        }

        async function sendTest() {
            try {
                const res = await fetch('/api/push/test', { method: 'POST' });
                const result = await res.json();
                console.log('Test result:', result);
            } catch (e) {
                console.error('Test failed:', e);
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000;

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';

            return date.toLocaleDateString();
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        init();
    </script>
</body>
</html>
